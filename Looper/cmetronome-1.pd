#N canvas 0 0 1276 724 10;
#X text 16 57 I did one of these earlier \, but don't have the file
handy \, hence the re-do for Hands-On Science.;
#X text 1160 841 Bar;
#X text 778 848 Beat;
#X text 12 864 Tick;
#X text 18 17 Metronome abstraction with bells and whistles \, so to
speak. Chris Edwards \, 2007-01-17.;
#X text 553 94 Beats per bar;
#X text 430 95 Beats per minute;
#X text 132 682 Various counters;
#X text 600 75 Metronome settings;
#X obj 1137 606 metro;
#X msg 1110 535 1;
#X msg 1164 535 0;
#X msg 1109 519 start;
#X msg 1164 519 stop;
#X msg 1212 519 reset;
#X text 1167 497 Metronome controls;
#X obj 1137 629 bng 15 250 50 0 empty empty empty 0 -6 0 8 -262144
-1 -1;
#X obj 918 798 int;
#X obj 967 797 + 1;
#X obj 911 749 receive cmetronome_reset;
#X obj 1212 558 send cmetronome_reset;
#X obj 189 819 int;
#X obj 238 819 + 1;
#X obj 190 788 bng 15 250 50 0 empty empty empty 0 -6 0 8 -262144 -1
-1;
#X obj 138 747 receive cmetronome_reset;
#X obj 69 723 t b i;
#X obj 1143 728 receive cmetronome_reset;
#X obj 1193 795 int;
#X obj 1252 798 + 1;
#X text 648 2 User specifies beats per minute \, beats per bar \, and
ticks per beat. The patch calculates the tick period in ms and uses
that for the [metro] \, and all the other counters are derived from
that (resetting and incrementing the next counter in the hierarchy).
;
#X obj 707 661 bng 15 250 50 0 empty empty empty 0 -6 0 8 -262144 -1
-1;
#X obj 813 726 t b i;
#X obj 1077 657 bng 15 250 50 0 empty empty empty 0 -6 0 8 -262144
-1 -1;
#X msg 140 819 0;
#X msg 877 798 0;
#X text 9 168 TODO: change counter slaving so that changing ticks won't
reset where we are in the bar \, i.e. bar -> tick. (Might not be easy!)
If this worked \, you could change TPB on thee fly without affecting
the beat \, which might be useful.;
#X obj 1137 652 send cmetronome_tick_event;
#X obj 190 772 receive cmetronome_tick_event;
#X obj 490 24 loadbang;
#X msg 644 286 4;
#X msg 890 253 6;
#X obj 1192 840 outlet;
#X obj 815 847 outlet;
#X obj 70 859 outlet;
#X obj 20 407 inlet;
#X text 9 225 TODO: handle irregular meters?;
#X text 10 246 TODO: filter out beat values that are beats-per-bar
+ 1 (and do the same for ticks). They're instantaneous \, but they're
there in the output.;
#X text 9 328 TODO: use triggers instead of bangs where appropriate
(to save on redrawing and to keep things tidy if graphed on parent).
;
#X obj 70 819 moses;
#X text 12 135 TODO: don't trigger metronome sound on a reset of the
current counter? Should a reset set the counter to 0:0:-1?;
#X obj 814 798 moses;
#X text 7 294 TODO: support banging with start \, stop and reset messages.
;
#X obj 923 444 route bang float symbol list;
#X obj 1114 472 route start stop reset;
#X obj 431 142 max 1;
#X text 12 102 TODO: add a millisecond counter \, updated every tick?
If that works \, whi not also hh:mm:ss?;
#X obj 431 114 inlet;
#X text 675 96 Sub-beats per beat;
#X obj 675 313 send cmetronome_sub-beats_per_bar;
#X obj 569 330 send cmetronome_beats_per_bar;
#X obj 426 353 send cmetronome_beats_per_minute;
#X obj 813 710 receive cmetronome_beats_per_bar;
#X obj 1167 584 receive cmetronome_ms_per_tick;
#X text 1129 447 Start | Pause | Stop (Pause + Reset) | Reset;
#X text 1090 34 TODO: creation messages! [cmetronome <b/min> <b/bar>
<sb/bar> <t/b>];
#X text 1099 78 TODO: transport controls \, e.g. seek?;
#X obj 226 450 receive cmetronome_beats_per_minute;
#X msg 191 498 60000;
#X text 43 498 Milliseconds per minute;
#X obj 212 526 /;
#X obj 450 422 receive cmetronome_sub-beats_per_bar;
#X obj 810 289 send cmetronome_ticks_per_sub-beat;
#X obj 69 707 receive cmetronome_ticks_per_sub-beat;
#X obj 493 536 *;
#X obj 349 582 /;
#X floatatom 349 613 5 0 0 0 - - -;
#X text 245 523 milliseconds per beat;
#X text 520 535 ticks per beat;
#X obj 325 636 send cmetronome_ms_per_tick;
#X obj 225 472 t b f;
#X obj 479 513 f;
#X obj 490 466 f;
#X obj 489 489 t b f;
#X obj 392 556 t b f;
#X obj 491 443 receive cmetronome_ticks_per_sub-beat;
#X text 296 397 Derive ms/tick \, the fundamental period for the metronome
;
#X text 1126 387 The base metronome (tick generator);
#X obj 578 795 int;
#X obj 627 794 + 1;
#X obj 558 731 receive cmetronome_reset;
#X obj 381 681 bng 15 250 50 0 empty empty empty 0 -6 0 8 -262144 -1
-1;
#X obj 473 724 t b i;
#X msg 537 795 0;
#X obj 474 844 outlet;
#X obj 474 795 moses;
#X obj 473 708 receive cmetronome_sub-beats_per_bar;
#X text 411 845 Sub-Beat;
#X text 1097 107 Note: it probably doesn't particularly make sense
to actually use this as a Pd abstraction \, because generally there
is only one metronome for an entire performance. Just having the patch
open and tweaking the settings is probably a more likely scenario.
;
#X text 1097 180 Although \, instantiating it to set the tempo in a
master patch of the performance would make sense \, otherwise you'd
have to set the parameters by hand every time...;
#X obj 138 780 - 1;
#X obj 571 766 - 1;
#X obj 913 773 - 1;
#X msg 1143 744 -1;
#X text 1096 255 Then again \, it's probably cleaner to make this properly
encaspulated and provide controls either as graph-on-parent elements
or inlets. It's probably bad form to go [send]ing stuff in secret!
;
#X obj 568 109 inlet;
#X obj 678 112 inlet;
#X obj 822 115 inlet;
#X text 823 99 Ticks per sub-beat;
#X text -17 388 Make the first inlet the transport control;
#X obj 21 434 send \$0_transport;
#X obj 923 417 receive \$0_transport;
#X text 822 469 Note: start/stop/reset are not symbols!;
#X obj 459 222 == 0;
#X msg 510 282 120;
#X text 454 176 BPM defaults to 120;
#X obj 1290 472 loadbang;
#X obj 459 195 float \$1;
#X obj 585 285 float \$2;
#X obj 694 284 float \$3;
#X obj 824 251 float \$4;
#X obj 459 249 moses 1;
#X obj 442 291 float \$1;
#X obj 454 271 t b;
#X text 388 602 milliseconds per tick (the base metro period \, from
which everything else is derived);
#X obj 595 188 float \$2;
#X obj 595 208 == 0;
#X obj 594 231 moses 1;
#X obj 593 253 t b;
#X obj 566 141 max 1;
#X obj 554 203 min 24;
#X text 592 169 b/bar def 4;
#X msg 757 284 2;
#X obj 711 172 float \$3;
#X obj 700 193 == 0;
#X obj 700 216 moses 1;
#X obj 702 243 t b;
#X obj 673 142 max 1;
#X obj 666 178 min 12;
#X text 717 152 sb/b def 2;
#X obj 813 142 max 1;
#X obj 811 164 min 48;
#X obj 897 157 float \$4;
#X obj 896 178 == 0;
#X obj 894 201 moses 1;
#X obj 880 224 t b;
#X text 301 917 * On a reset \, set the tick \, sub-beat and beat counter
to one before the next bar rollover \, and the bar counter to -1 \,
so that the next tick starts the first beat of the first bar.;
#X obj 1212 539 t b;
#X connect 9 0 16 0;
#X connect 10 0 9 0;
#X connect 11 0 9 0;
#X connect 12 0 10 0;
#X connect 13 0 11 0;
#X connect 14 0 146 0;
#X connect 16 0 36 0;
#X connect 17 0 18 0;
#X connect 17 0 50 0;
#X connect 18 0 17 1;
#X connect 19 0 101 0;
#X connect 21 0 22 0;
#X connect 21 0 48 0;
#X connect 22 0 21 1;
#X connect 23 0 21 0;
#X connect 24 0 99 0;
#X connect 25 0 48 0;
#X connect 25 1 48 1;
#X connect 25 1 99 0;
#X connect 26 0 102 0;
#X connect 27 0 28 0;
#X connect 27 0 41 0;
#X connect 28 0 27 1;
#X connect 30 0 17 0;
#X connect 31 0 50 0;
#X connect 31 1 50 1;
#X connect 31 1 101 0;
#X connect 32 0 27 0;
#X connect 33 0 21 0;
#X connect 34 0 17 0;
#X connect 37 0 23 0;
#X connect 38 0 116 0;
#X connect 38 0 124 0;
#X connect 38 0 132 0;
#X connect 38 0 141 0;
#X connect 39 0 59 0;
#X connect 40 0 71 0;
#X connect 44 0 109 0;
#X connect 48 0 43 0;
#X connect 48 1 33 0;
#X connect 48 1 90 0;
#X connect 50 0 42 0;
#X connect 50 1 34 0;
#X connect 50 1 32 0;
#X connect 52 4 53 0;
#X connect 53 0 12 0;
#X connect 53 1 13 0;
#X connect 53 2 14 0;
#X connect 54 0 60 0;
#X connect 56 0 54 0;
#X connect 61 0 31 0;
#X connect 62 0 9 1;
#X connect 66 0 79 0;
#X connect 67 0 69 0;
#X connect 69 0 74 0;
#X connect 70 0 80 0;
#X connect 72 0 25 0;
#X connect 73 0 83 0;
#X connect 74 0 75 0;
#X connect 74 0 78 0;
#X connect 79 0 67 0;
#X connect 79 1 69 1;
#X connect 80 0 73 0;
#X connect 81 0 82 0;
#X connect 82 0 80 0;
#X connect 82 1 73 1;
#X connect 83 0 74 0;
#X connect 83 1 74 1;
#X connect 84 0 81 0;
#X connect 87 0 88 0;
#X connect 87 0 94 0;
#X connect 88 0 87 1;
#X connect 89 0 100 0;
#X connect 90 0 87 0;
#X connect 91 0 94 0;
#X connect 91 1 94 1;
#X connect 91 1 100 0;
#X connect 92 0 87 0;
#X connect 94 0 93 0;
#X connect 94 1 92 0;
#X connect 94 1 30 0;
#X connect 95 0 91 0;
#X connect 99 0 21 0;
#X connect 100 0 87 0;
#X connect 101 0 17 0;
#X connect 102 0 27 0;
#X connect 104 0 128 0;
#X connect 105 0 136 0;
#X connect 106 0 139 0;
#X connect 110 0 52 0;
#X connect 112 0 120 0;
#X connect 113 0 60 0;
#X connect 115 0 14 0;
#X connect 116 0 112 0;
#X connect 117 0 59 0;
#X connect 118 0 58 0;
#X connect 119 0 71 0;
#X connect 120 0 122 0;
#X connect 120 1 113 0;
#X connect 121 0 60 0;
#X connect 122 0 121 0;
#X connect 124 0 125 0;
#X connect 125 0 126 0;
#X connect 126 0 127 0;
#X connect 126 1 39 0;
#X connect 127 0 117 0;
#X connect 128 0 129 0;
#X connect 129 0 59 0;
#X connect 131 0 58 0;
#X connect 132 0 133 0;
#X connect 133 0 134 0;
#X connect 134 0 135 0;
#X connect 134 1 131 0;
#X connect 135 0 118 0;
#X connect 136 0 137 0;
#X connect 137 0 58 0;
#X connect 139 0 140 0;
#X connect 140 0 71 0;
#X connect 141 0 142 0;
#X connect 142 0 143 0;
#X connect 143 0 144 0;
#X connect 143 1 40 0;
#X connect 144 0 119 0;
#X connect 146 0 20 0;
